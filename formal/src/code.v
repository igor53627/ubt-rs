(* Generated by rocq-of-rust *)
Require Import RocqOfRust.RocqOfRust.

Module code.
  Definition value_CODE_CHUNK_DATA_SIZE (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    ltac:(M.monadic (M.alloc (| Ty.path "usize", Value.Integer IntegerKind.Usize 31 |))).
  
  Global Instance Instance_IsConstant_value_CODE_CHUNK_DATA_SIZE :
    M.IsFunction.C "ubt::code::CODE_CHUNK_DATA_SIZE" value_CODE_CHUNK_DATA_SIZE.
  Admitted.
  Global Typeclasses Opaque value_CODE_CHUNK_DATA_SIZE.
  
  (* StructRecord
    {
      name := "CodeChunk";
      const_params := [];
      ty_params := [];
      fields :=
        [
          ("leading_pushdata", Ty.path "u8");
          ("data",
            Ty.apply
              (Ty.path "array")
              [ M.unevaluated_const (mk_str (| "ubt_code_CodeChunk_data_discriminant" |)) ]
              [ Ty.path "u8" ])
        ];
    } *)
  
  Module Impl_core_clone_Clone_for_ubt_code_CodeChunk.
    Definition Self : Ty.t := Ty.path "ubt::code::CodeChunk".
    
    (* Clone *)
    Definition clone (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [ self ] =>
        ltac:(M.monadic
          (let self :=
            M.alloc (| Ty.apply (Ty.path "&") [] [ Ty.path "ubt::code::CodeChunk" ], self |) in
          M.match_operator (|
            Ty.path "ubt::code::CodeChunk",
            Value.DeclaredButUndefined,
            [
              fun γ =>
                ltac:(M.monadic
                  (M.match_operator (|
                    Ty.path "ubt::code::CodeChunk",
                    Value.DeclaredButUndefined,
                    [ fun γ => ltac:(M.monadic (M.read (| M.deref (| M.read (| self |) |) |))) ]
                  |)))
            ]
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      M.IsTraitInstance
        "core::clone::Clone"
        (* Trait polymorphic consts *) []
        (* Trait polymorphic types *) []
        Self
        (* Instance *) [ ("clone", InstanceField.Method clone) ].
  End Impl_core_clone_Clone_for_ubt_code_CodeChunk.
  
  Module Impl_core_marker_Copy_for_ubt_code_CodeChunk.
    Definition Self : Ty.t := Ty.path "ubt::code::CodeChunk".
    
    Axiom Implements :
      M.IsTraitInstance
        "core::marker::Copy"
        (* Trait polymorphic consts *) []
        (* Trait polymorphic types *) []
        Self
        (* Instance *) [].
  End Impl_core_marker_Copy_for_ubt_code_CodeChunk.
  
  Module Impl_core_fmt_Debug_for_ubt_code_CodeChunk.
    Definition Self : Ty.t := Ty.path "ubt::code::CodeChunk".
    
    (* Debug *)
    Definition fmt (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [ self; f ] =>
        ltac:(M.monadic
          (let self :=
            M.alloc (| Ty.apply (Ty.path "&") [] [ Ty.path "ubt::code::CodeChunk" ], self |) in
          let f :=
            M.alloc (| Ty.apply (Ty.path "&mut") [] [ Ty.path "core::fmt::Formatter" ], f |) in
          M.call_closure (|
            Ty.apply
              (Ty.path "core::result::Result")
              []
              [ Ty.tuple []; Ty.path "core::fmt::Error" ],
            M.get_associated_function (|
              Ty.path "core::fmt::Formatter",
              "debug_struct_field2_finish",
              [],
              []
            |),
            [
              M.borrow (| Pointer.Kind.MutRef, M.deref (| M.read (| f |) |) |);
              M.borrow (| Pointer.Kind.Ref, M.deref (| mk_str (| "CodeChunk" |) |) |);
              M.borrow (| Pointer.Kind.Ref, M.deref (| mk_str (| "leading_pushdata" |) |) |);
              M.call_closure (|
                Ty.apply (Ty.path "&") [] [ Ty.dyn [ ("core::fmt::Debug::Trait", []) ] ],
                M.pointer_coercion
                  M.PointerCoercion.Unsize
                  (Ty.apply (Ty.path "&") [] [ Ty.path "u8" ])
                  (Ty.apply (Ty.path "&") [] [ Ty.dyn [ ("core::fmt::Debug::Trait", []) ] ]),
                [
                  M.borrow (|
                    Pointer.Kind.Ref,
                    M.deref (|
                      M.borrow (|
                        Pointer.Kind.Ref,
                        M.SubPointer.get_struct_record_field (|
                          M.deref (| M.read (| self |) |),
                          "ubt::code::CodeChunk",
                          "leading_pushdata"
                        |)
                      |)
                    |)
                  |)
                ]
              |);
              M.borrow (| Pointer.Kind.Ref, M.deref (| mk_str (| "data" |) |) |);
              M.call_closure (|
                Ty.apply (Ty.path "&") [] [ Ty.dyn [ ("core::fmt::Debug::Trait", []) ] ],
                M.pointer_coercion
                  M.PointerCoercion.Unsize
                  (Ty.apply
                    (Ty.path "&")
                    []
                    [
                      Ty.apply
                        (Ty.path "&")
                        []
                        [
                          Ty.apply
                            (Ty.path "array")
                            [ Value.Integer IntegerKind.Usize 31 ]
                            [ Ty.path "u8" ]
                        ]
                    ])
                  (Ty.apply (Ty.path "&") [] [ Ty.dyn [ ("core::fmt::Debug::Trait", []) ] ]),
                [
                  M.borrow (|
                    Pointer.Kind.Ref,
                    M.deref (|
                      M.borrow (|
                        Pointer.Kind.Ref,
                        M.alloc (|
                          Ty.apply
                            (Ty.path "&")
                            []
                            [
                              Ty.apply
                                (Ty.path "array")
                                [ Value.Integer IntegerKind.Usize 31 ]
                                [ Ty.path "u8" ]
                            ],
                          M.borrow (|
                            Pointer.Kind.Ref,
                            M.SubPointer.get_struct_record_field (|
                              M.deref (| M.read (| self |) |),
                              "ubt::code::CodeChunk",
                              "data"
                            |)
                          |)
                        |)
                      |)
                    |)
                  |)
                ]
              |)
            ]
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      M.IsTraitInstance
        "core::fmt::Debug"
        (* Trait polymorphic consts *) []
        (* Trait polymorphic types *) []
        Self
        (* Instance *) [ ("fmt", InstanceField.Method fmt) ].
  End Impl_core_fmt_Debug_for_ubt_code_CodeChunk.
  
  Module Impl_core_marker_StructuralPartialEq_for_ubt_code_CodeChunk.
    Definition Self : Ty.t := Ty.path "ubt::code::CodeChunk".
    
    Axiom Implements :
      M.IsTraitInstance
        "core::marker::StructuralPartialEq"
        (* Trait polymorphic consts *) []
        (* Trait polymorphic types *) []
        Self
        (* Instance *) [].
  End Impl_core_marker_StructuralPartialEq_for_ubt_code_CodeChunk.
  
  Module Impl_core_cmp_PartialEq_ubt_code_CodeChunk_for_ubt_code_CodeChunk.
    Definition Self : Ty.t := Ty.path "ubt::code::CodeChunk".
    
    (* PartialEq *)
    Definition eq (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [ self; other ] =>
        ltac:(M.monadic
          (let self :=
            M.alloc (| Ty.apply (Ty.path "&") [] [ Ty.path "ubt::code::CodeChunk" ], self |) in
          let other :=
            M.alloc (| Ty.apply (Ty.path "&") [] [ Ty.path "ubt::code::CodeChunk" ], other |) in
          LogicalOp.and (|
            M.call_closure (|
              Ty.path "bool",
              BinOp.eq,
              [
                M.read (|
                  M.SubPointer.get_struct_record_field (|
                    M.deref (| M.read (| self |) |),
                    "ubt::code::CodeChunk",
                    "leading_pushdata"
                  |)
                |);
                M.read (|
                  M.SubPointer.get_struct_record_field (|
                    M.deref (| M.read (| other |) |),
                    "ubt::code::CodeChunk",
                    "leading_pushdata"
                  |)
                |)
              ]
            |),
            ltac:(M.monadic
              (M.call_closure (|
                Ty.path "bool",
                M.get_trait_method (|
                  "core::cmp::PartialEq",
                  Ty.apply
                    (Ty.path "array")
                    [ Value.Integer IntegerKind.Usize 31 ]
                    [ Ty.path "u8" ],
                  [],
                  [
                    Ty.apply
                      (Ty.path "array")
                      [ Value.Integer IntegerKind.Usize 31 ]
                      [ Ty.path "u8" ]
                  ],
                  "eq",
                  [],
                  []
                |),
                [
                  M.borrow (|
                    Pointer.Kind.Ref,
                    M.SubPointer.get_struct_record_field (|
                      M.deref (| M.read (| self |) |),
                      "ubt::code::CodeChunk",
                      "data"
                    |)
                  |);
                  M.borrow (|
                    Pointer.Kind.Ref,
                    M.SubPointer.get_struct_record_field (|
                      M.deref (| M.read (| other |) |),
                      "ubt::code::CodeChunk",
                      "data"
                    |)
                  |)
                ]
              |)))
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      M.IsTraitInstance
        "core::cmp::PartialEq"
        (* Trait polymorphic consts *) []
        (* Trait polymorphic types *) [ Ty.path "ubt::code::CodeChunk" ]
        Self
        (* Instance *) [ ("eq", InstanceField.Method eq) ].
  End Impl_core_cmp_PartialEq_ubt_code_CodeChunk_for_ubt_code_CodeChunk.
  
  Module Impl_core_cmp_Eq_for_ubt_code_CodeChunk.
    Definition Self : Ty.t := Ty.path "ubt::code::CodeChunk".
    
    (* Eq *)
    Definition assert_receiver_is_total_eq
        (ε : list Value.t)
        (τ : list Ty.t)
        (α : list Value.t)
        : M :=
      match ε, τ, α with
      | [], [], [ self ] =>
        ltac:(M.monadic
          (let self :=
            M.alloc (| Ty.apply (Ty.path "&") [] [ Ty.path "ubt::code::CodeChunk" ], self |) in
          M.match_operator (|
            Ty.tuple [],
            Value.DeclaredButUndefined,
            [
              fun γ =>
                ltac:(M.monadic
                  (M.match_operator (|
                    Ty.tuple [],
                    Value.DeclaredButUndefined,
                    [ fun γ => ltac:(M.monadic (Value.Tuple [])) ]
                  |)))
            ]
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Axiom Implements :
      M.IsTraitInstance
        "core::cmp::Eq"
        (* Trait polymorphic consts *) []
        (* Trait polymorphic types *) []
        Self
        (* Instance *)
        [ ("assert_receiver_is_total_eq", InstanceField.Method assert_receiver_is_total_eq) ].
  End Impl_core_cmp_Eq_for_ubt_code_CodeChunk.
  
  Module Impl_ubt_code_CodeChunk.
    Definition Self : Ty.t := Ty.path "ubt::code::CodeChunk".
    
    (*
        pub const fn new(leading_pushdata: u8, data: [u8; CODE_CHUNK_DATA_SIZE]) -> Self {
            Self { leading_pushdata, data }
        }
    *)
    Definition new (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [ leading_pushdata; data ] =>
        ltac:(M.monadic
          (let leading_pushdata := M.alloc (| Ty.path "u8", leading_pushdata |) in
          let data :=
            M.alloc (|
              Ty.apply
                (Ty.path "array")
                [ M.unevaluated_const (mk_str (| "ubt_code_new_discriminant" |)) ]
                [ Ty.path "u8" ],
              data
            |) in
          Value.mkStructRecord
            "ubt::code::CodeChunk"
            []
            []
            [ ("leading_pushdata", M.read (| leading_pushdata |)); ("data", M.read (| data |)) ]))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Global Instance AssociatedFunction_new : M.IsAssociatedFunction.C Self "new" new.
    Admitted.
    Global Typeclasses Opaque new.
    
    (*
        pub fn encode(&self) -> B256 {
            let mut bytes = [0u8; 32];
            bytes[0] = self.leading_pushdata;
            bytes[1..32].copy_from_slice(&self.data);
            B256::from(bytes)
        }
    *)
    Definition encode (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [ self ] =>
        ltac:(M.monadic
          (let self :=
            M.alloc (| Ty.apply (Ty.path "&") [] [ Ty.path "ubt::code::CodeChunk" ], self |) in
          M.read (|
            let~ bytes :
                Ty.apply
                  (Ty.path "array")
                  [ Value.Integer IntegerKind.Usize 32 ]
                  [ Ty.path "u8" ] :=
              lib.repeat (| Value.Integer IntegerKind.U8 0, Value.Integer IntegerKind.Usize 32 |) in
            let~ _ : Ty.tuple [] :=
              M.write (|
                M.SubPointer.get_array_field (| bytes, Value.Integer IntegerKind.Usize 0 |),
                M.read (|
                  M.SubPointer.get_struct_record_field (|
                    M.deref (| M.read (| self |) |),
                    "ubt::code::CodeChunk",
                    "leading_pushdata"
                  |)
                |)
              |) in
            let~ _ : Ty.tuple [] :=
              M.call_closure (|
                Ty.tuple [],
                M.get_associated_function (|
                  Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ],
                  "copy_from_slice",
                  [],
                  []
                |),
                [
                  M.borrow (|
                    Pointer.Kind.MutRef,
                    M.deref (|
                      M.call_closure (|
                        Ty.apply
                          (Ty.path "&mut")
                          []
                          [ Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ] ],
                        M.get_trait_method (|
                          "core::ops::index::IndexMut",
                          Ty.apply
                            (Ty.path "array")
                            [ Value.Integer IntegerKind.Usize 32 ]
                            [ Ty.path "u8" ],
                          [],
                          [ Ty.apply (Ty.path "core::ops::range::Range") [] [ Ty.path "usize" ] ],
                          "index_mut",
                          [],
                          []
                        |),
                        [
                          M.borrow (| Pointer.Kind.MutRef, bytes |);
                          Value.mkStructRecord
                            "core::ops::range::Range"
                            []
                            [ Ty.path "usize" ]
                            [
                              ("start", Value.Integer IntegerKind.Usize 1);
                              ("end_", Value.Integer IntegerKind.Usize 32)
                            ]
                        ]
                      |)
                    |)
                  |);
                  M.call_closure (|
                    Ty.apply (Ty.path "&") [] [ Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ] ],
                    M.pointer_coercion
                      M.PointerCoercion.Unsize
                      (Ty.apply
                        (Ty.path "&")
                        []
                        [
                          Ty.apply
                            (Ty.path "array")
                            [ Value.Integer IntegerKind.Usize 31 ]
                            [ Ty.path "u8" ]
                        ])
                      (Ty.apply
                        (Ty.path "&")
                        []
                        [ Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ] ]),
                    [
                      M.borrow (|
                        Pointer.Kind.Ref,
                        M.deref (|
                          M.borrow (|
                            Pointer.Kind.Ref,
                            M.SubPointer.get_struct_record_field (|
                              M.deref (| M.read (| self |) |),
                              "ubt::code::CodeChunk",
                              "data"
                            |)
                          |)
                        |)
                      |)
                    ]
                  |)
                ]
              |) in
            M.alloc (|
              Ty.apply
                (Ty.path "alloy_primitives::bits::fixed::FixedBytes")
                [ Value.Integer IntegerKind.Usize 32 ]
                [],
              M.call_closure (|
                Ty.apply
                  (Ty.path "alloy_primitives::bits::fixed::FixedBytes")
                  [ Value.Integer IntegerKind.Usize 32 ]
                  [],
                M.get_trait_method (|
                  "core::convert::From",
                  Ty.apply
                    (Ty.path "alloy_primitives::bits::fixed::FixedBytes")
                    [ Value.Integer IntegerKind.Usize 32 ]
                    [],
                  [],
                  [
                    Ty.apply
                      (Ty.path "array")
                      [ Value.Integer IntegerKind.Usize 32 ]
                      [ Ty.path "u8" ]
                  ],
                  "from",
                  [],
                  []
                |),
                [ M.read (| bytes |) ]
              |)
            |)
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Global Instance AssociatedFunction_encode : M.IsAssociatedFunction.C Self "encode" encode.
    Admitted.
    Global Typeclasses Opaque encode.
    
    (*
        pub fn decode(value: B256) -> Self {
            let bytes = value.as_slice();
            let mut data = [0u8; CODE_CHUNK_DATA_SIZE];
            data.copy_from_slice(&bytes[1..32]);
            Self {
                leading_pushdata: bytes[0],
                data,
            }
        }
    *)
    Definition decode (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
      match ε, τ, α with
      | [], [], [ value ] =>
        ltac:(M.monadic
          (let value :=
            M.alloc (|
              Ty.apply
                (Ty.path "alloy_primitives::bits::fixed::FixedBytes")
                [ Value.Integer IntegerKind.Usize 32 ]
                [],
              value
            |) in
          M.read (|
            let~ bytes :
                Ty.apply (Ty.path "&") [] [ Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ] ] :=
              M.call_closure (|
                Ty.apply (Ty.path "&") [] [ Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ] ],
                M.get_associated_function (|
                  Ty.apply
                    (Ty.path "alloy_primitives::bits::fixed::FixedBytes")
                    [ Value.Integer IntegerKind.Usize 32 ]
                    [],
                  "as_slice",
                  [],
                  []
                |),
                [ M.borrow (| Pointer.Kind.Ref, value |) ]
              |) in
            let~ data :
                Ty.apply
                  (Ty.path "array")
                  [ Value.Integer IntegerKind.Usize 31 ]
                  [ Ty.path "u8" ] :=
              lib.repeat (| Value.Integer IntegerKind.U8 0, Value.Integer IntegerKind.Usize 31 |) in
            let~ _ : Ty.tuple [] :=
              M.call_closure (|
                Ty.tuple [],
                M.get_associated_function (|
                  Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ],
                  "copy_from_slice",
                  [],
                  []
                |),
                [
                  M.call_closure (|
                    Ty.apply (Ty.path "&mut") [] [ Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ] ],
                    M.pointer_coercion
                      M.PointerCoercion.Unsize
                      (Ty.apply
                        (Ty.path "&mut")
                        []
                        [
                          Ty.apply
                            (Ty.path "array")
                            [ Value.Integer IntegerKind.Usize 31 ]
                            [ Ty.path "u8" ]
                        ])
                      (Ty.apply
                        (Ty.path "&mut")
                        []
                        [ Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ] ]),
                    [ M.borrow (| Pointer.Kind.MutRef, data |) ]
                  |);
                  M.borrow (|
                    Pointer.Kind.Ref,
                    M.deref (|
                      M.borrow (|
                        Pointer.Kind.Ref,
                        M.deref (|
                          M.call_closure (|
                            Ty.apply
                              (Ty.path "&")
                              []
                              [ Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ] ],
                            M.get_trait_method (|
                              "core::ops::index::Index",
                              Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ],
                              [],
                              [ Ty.apply (Ty.path "core::ops::range::Range") [] [ Ty.path "usize" ]
                              ],
                              "index",
                              [],
                              []
                            |),
                            [
                              M.borrow (| Pointer.Kind.Ref, M.deref (| M.read (| bytes |) |) |);
                              Value.mkStructRecord
                                "core::ops::range::Range"
                                []
                                [ Ty.path "usize" ]
                                [
                                  ("start", Value.Integer IntegerKind.Usize 1);
                                  ("end_", Value.Integer IntegerKind.Usize 32)
                                ]
                            ]
                          |)
                        |)
                      |)
                    |)
                  |)
                ]
              |) in
            M.alloc (|
              Ty.path "ubt::code::CodeChunk",
              Value.mkStructRecord
                "ubt::code::CodeChunk"
                []
                []
                [
                  ("leading_pushdata",
                    M.read (|
                      M.SubPointer.get_array_field (|
                        M.deref (| M.read (| bytes |) |),
                        Value.Integer IntegerKind.Usize 0
                      |)
                    |));
                  ("data", M.read (| data |))
                ]
            |)
          |)))
      | _, _, _ => M.impossible "wrong number of arguments"
      end.
    
    Global Instance AssociatedFunction_decode : M.IsAssociatedFunction.C Self "decode" decode.
    Admitted.
    Global Typeclasses Opaque decode.
  End Impl_ubt_code_CodeChunk.
  
  (*
  fn push_size(opcode: u8) -> usize {
      if (0x60..=0x7f).contains(&opcode) {
          (opcode - 0x5f) as usize // PUSH1 = 0x60 pushes 1 byte, PUSH32 = 0x7f pushes 32 bytes
      } else {
          0
      }
  }
  *)
  Definition push_size (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [], [ opcode ] =>
      ltac:(M.monadic
        (let opcode := M.alloc (| Ty.path "u8", opcode |) in
        M.match_operator (|
          Ty.path "usize",
          M.alloc (| Ty.tuple [], Value.Tuple [] |),
          [
            fun γ =>
              ltac:(M.monadic
                (let γ :=
                  M.use
                    (M.alloc (|
                      Ty.path "bool",
                      M.call_closure (|
                        Ty.path "bool",
                        M.get_associated_function (|
                          Ty.apply (Ty.path "core::ops::range::RangeInclusive") [] [ Ty.path "u8" ],
                          "contains",
                          [],
                          [ Ty.path "u8" ]
                        |),
                        [
                          M.borrow (|
                            Pointer.Kind.Ref,
                            M.alloc (|
                              Ty.apply
                                (Ty.path "core::ops::range::RangeInclusive")
                                []
                                [ Ty.path "u8" ],
                              M.call_closure (|
                                Ty.apply
                                  (Ty.path "core::ops::range::RangeInclusive")
                                  []
                                  [ Ty.path "u8" ],
                                M.get_associated_function (|
                                  Ty.apply
                                    (Ty.path "core::ops::range::RangeInclusive")
                                    []
                                    [ Ty.path "u8" ],
                                  "new",
                                  [],
                                  []
                                |),
                                [ Value.Integer IntegerKind.U8 96; Value.Integer IntegerKind.U8 127
                                ]
                              |)
                            |)
                          |);
                          M.borrow (|
                            Pointer.Kind.Ref,
                            M.deref (| M.borrow (| Pointer.Kind.Ref, opcode |) |)
                          |)
                        ]
                      |)
                    |)) in
                let _ := is_constant_or_break_match (| M.read (| γ |), Value.Bool true |) in
                M.cast
                  (Ty.path "usize")
                  (M.call_closure (|
                    Ty.path "u8",
                    BinOp.Wrap.sub,
                    [ M.read (| opcode |); Value.Integer IntegerKind.U8 95 ]
                  |))));
            fun γ => ltac:(M.monadic (Value.Integer IntegerKind.Usize 0))
          ]
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_push_size : M.IsFunction.C "ubt::code::push_size" push_size.
  Admitted.
  Global Typeclasses Opaque push_size.
  
  (*
  pub fn chunkify_code(bytecode: &[u8]) -> Vec<CodeChunk> {
      if bytecode.is_empty() {
          return vec![];
      }
  
      let num_chunks = (bytecode.len() + CODE_CHUNK_DATA_SIZE - 1) / CODE_CHUNK_DATA_SIZE;
      let mut chunks = Vec::with_capacity(num_chunks);
      
      // Track how many bytes of PUSHDATA remain from previous instruction
      let mut pushdata_remaining: usize = 0;
  
      for chunk_idx in 0..num_chunks {
          let start = chunk_idx * CODE_CHUNK_DATA_SIZE;
          let end = std::cmp::min(start + CODE_CHUNK_DATA_SIZE, bytecode.len());
          
          // How many bytes at the start of this chunk are PUSHDATA from previous chunk?
          let leading_pushdata = std::cmp::min(pushdata_remaining, end - start) as u8;
          
          let mut data = [0u8; CODE_CHUNK_DATA_SIZE];
          let chunk_data = &bytecode[start..end];
          data[..chunk_data.len()].copy_from_slice(chunk_data);
          
          chunks.push(CodeChunk::new(leading_pushdata, data));
          
          // Update pushdata_remaining for next chunk
          if pushdata_remaining > CODE_CHUNK_DATA_SIZE {
              pushdata_remaining -= CODE_CHUNK_DATA_SIZE;
          } else {
              // Scan this chunk for PUSH instructions
              pushdata_remaining = 0;
              let mut i = pushdata_remaining.max(leading_pushdata as usize);
              while i < chunk_data.len() {
                  let opcode = chunk_data[i];
                  let push_bytes = push_size(opcode);
                  if push_bytes > 0 {
                      let bytes_in_chunk = chunk_data.len() - i - 1;
                      if push_bytes > bytes_in_chunk {
                          pushdata_remaining = push_bytes - bytes_in_chunk;
                      }
                      i += push_bytes + 1;
                  } else {
                      i += 1;
                  }
              }
          }
      }
  
      chunks
  }
  *)
  Definition chunkify_code (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [], [ bytecode ] =>
      ltac:(M.monadic
        (let bytecode :=
          M.alloc (|
            Ty.apply (Ty.path "&") [] [ Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ] ],
            bytecode
          |) in
        M.catch_return
          (Ty.apply
            (Ty.path "alloc::vec::Vec")
            []
            [ Ty.path "ubt::code::CodeChunk"; Ty.path "alloc::alloc::Global" ]) (|
          ltac:(M.monadic
            (M.read (|
              let~ _ : Ty.tuple [] :=
                M.match_operator (|
                  Ty.tuple [],
                  M.alloc (| Ty.tuple [], Value.Tuple [] |),
                  [
                    fun γ =>
                      ltac:(M.monadic
                        (let γ :=
                          M.use
                            (M.alloc (|
                              Ty.path "bool",
                              M.call_closure (|
                                Ty.path "bool",
                                M.get_associated_function (|
                                  Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ],
                                  "is_empty",
                                  [],
                                  []
                                |),
                                [
                                  M.borrow (|
                                    Pointer.Kind.Ref,
                                    M.deref (| M.read (| bytecode |) |)
                                  |)
                                ]
                              |)
                            |)) in
                        let _ := is_constant_or_break_match (| M.read (| γ |), Value.Bool true |) in
                        M.never_to_any (|
                          M.read (|
                            M.return_ (|
                              M.call_closure (|
                                Ty.apply
                                  (Ty.path "alloc::vec::Vec")
                                  []
                                  [ Ty.path "ubt::code::CodeChunk"; Ty.path "alloc::alloc::Global"
                                  ],
                                M.get_associated_function (|
                                  Ty.apply
                                    (Ty.path "alloc::vec::Vec")
                                    []
                                    [ Ty.path "ubt::code::CodeChunk"; Ty.path "alloc::alloc::Global"
                                    ],
                                  "new",
                                  [],
                                  []
                                |),
                                []
                              |)
                            |)
                          |)
                        |)));
                    fun γ => ltac:(M.monadic (Value.Tuple []))
                  ]
                |) in
              let~ num_chunks : Ty.path "usize" :=
                M.call_closure (|
                  Ty.path "usize",
                  BinOp.Wrap.div,
                  [
                    M.call_closure (|
                      Ty.path "usize",
                      BinOp.Wrap.sub,
                      [
                        M.call_closure (|
                          Ty.path "usize",
                          BinOp.Wrap.add,
                          [
                            M.call_closure (|
                              Ty.path "usize",
                              M.get_associated_function (|
                                Ty.apply (Ty.path "slice") [] [ Ty.path "u8" ],
                                "len",
                                [],
                                []
                              |),
                              [ M.borrow (| Pointer.Kind.Ref, M.deref (| M.read (| bytecode |) |) |)
                              ]
                            |);
                            M.read (|
                              get_constant (| "ubt::code::CODE_CHUNK_DATA_SIZE", Ty.path "usize" |)
                            |)
                          ]
                        |);
                        Value.Integer IntegerKind.Usize 1
                      ]
                    |);
                    M.read (|
                      get_constant (| "ubt::code::CODE_CHUNK_DATA_SIZE", Ty.path "usize" |)
                    |)
                  ]
                |) in
              let~ chunks :
                  Ty.apply
                    (Ty.path "alloc::vec::Vec")
                    []
                    [ Ty.path "ubt::code::CodeChunk"; Ty.path "alloc::alloc::Global" ] :=
                M.call_closure (|
                  Ty.apply
                    (Ty.path "alloc::vec::Vec")
                    []
                    [ Ty.path "ubt::code::CodeChunk"; Ty.path "alloc::alloc::Global" ],
                  M.get_associated_function (|
                    Ty.apply
                      (Ty.path "alloc::vec::Vec")
                      []
                      [ Ty.path "ubt::code::CodeChunk"; Ty.path "alloc::alloc::Global" ],
                    "with_capacity",
                    [],
                    []
                  |),
                  [ M.read (| num_chunks |) ]
                |) in
              let~ pushdata_remaining : Ty.path "usize" := Value.Integer IntegerKind.Usize 0 in
              let~ _ : Ty.tuple [] :=
                M.read (|
                  M.use
                    (M.alloc (|
                      Ty.tuple [],
                      M.match_operator (|
                        Ty.tuple [],
                        M.alloc (|
                          Ty.apply (Ty.path "core::ops::range::Range") [] [ Ty.path "usize" ],
                          M.call_closure (|
                            Ty.apply (Ty.path "core::ops::range::Range") [] [ Ty.path "usize" ],
                            M.get_trait_method (|
                              "core::iter::traits::collect::IntoIterator",
                              Ty.apply (Ty.path "core::ops::range::Range") [] [ Ty.path "usize" ],
                              [],
                              [],
                              "into_iter",
                              [],
                              []
                            |),
                            [
                              Value.mkStructRecord
                                "core::ops::range::Range"
                                []
                                [ Ty.path "usize" ]
                                [
                                  ("start", Value.Integer IntegerKind.Usize 0);
                                  ("end_", M.read (| num_chunks |))
                                ]
                            ]
                          |)
                        |),
                        [
                          fun γ =>
                            ltac:(M.monadic
                              (let iter :=
                                M.copy (|
                                  Ty.apply
                                    (Ty.path "core::ops::range::Range")
                                    []
                                    [ Ty.path "usize" ],
                                  γ
                                |) in
                              M.read (|
                                M.loop (|
                                  Ty.tuple [],
                                  ltac:(M.monadic
                                    (let~ _ : Ty.tuple [] :=
                                      M.match_operator (|
                                        Ty.tuple [],
                                        M.alloc (|
                                          Ty.apply
                                            (Ty.path "core::option::Option")
                                            []
                                            [ Ty.path "usize" ],
                                          M.call_closure (|
                                            Ty.apply
                                              (Ty.path "core::option::Option")
                                              []
                                              [ Ty.path "usize" ],
                                            M.get_trait_method (|
                                              "core::iter::traits::iterator::Iterator",
                                              Ty.apply
                                                (Ty.path "core::ops::range::Range")
                                                []
                                                [ Ty.path "usize" ],
                                              [],
                                              [],
                                              "next",
                                              [],
                                              []
                                            |),
                                            [
                                              M.borrow (|
                                                Pointer.Kind.MutRef,
                                                M.deref (|
                                                  M.borrow (| Pointer.Kind.MutRef, iter |)
                                                |)
                                              |)
                                            ]
                                          |)
                                        |),
                                        [
                                          fun γ =>
                                            ltac:(M.monadic
                                              (let _ :=
                                                M.is_struct_tuple (|
                                                  γ,
                                                  "core::option::Option::None"
                                                |) in
                                              M.never_to_any (| M.read (| M.break (||) |) |)));
                                          fun γ =>
                                            ltac:(M.monadic
                                              (let γ0_0 :=
                                                M.SubPointer.get_struct_tuple_field (|
                                                  γ,
                                                  "core::option::Option::Some",
                                                  0
                                                |) in
                                              let chunk_idx := M.copy (| Ty.path "usize", γ0_0 |) in
                                              M.read (|
                                                let~ start : Ty.path "usize" :=
                                                  M.call_closure (|
                                                    Ty.path "usize",
                                                    BinOp.Wrap.mul,
                                                    [
                                                      M.read (| chunk_idx |);
                                                      M.read (|
                                                        get_constant (|
                                                          "ubt::code::CODE_CHUNK_DATA_SIZE",
                                                          Ty.path "usize"
                                                        |)
                                                      |)
                                                    ]
                                                  |) in
                                                let~ end_ : Ty.path "usize" :=
                                                  M.call_closure (|
                                                    Ty.path "usize",
                                                    M.get_function (|
                                                      "core::cmp::min",
                                                      [],
                                                      [ Ty.path "usize" ]
                                                    |),
                                                    [
                                                      M.call_closure (|
                                                        Ty.path "usize",
                                                        BinOp.Wrap.add,
                                                        [
                                                          M.read (| start |);
                                                          M.read (|
                                                            get_constant (|
                                                              "ubt::code::CODE_CHUNK_DATA_SIZE",
                                                              Ty.path "usize"
                                                            |)
                                                          |)
                                                        ]
                                                      |);
                                                      M.call_closure (|
                                                        Ty.path "usize",
                                                        M.get_associated_function (|
                                                          Ty.apply
                                                            (Ty.path "slice")
                                                            []
                                                            [ Ty.path "u8" ],
                                                          "len",
                                                          [],
                                                          []
                                                        |),
                                                        [
                                                          M.borrow (|
                                                            Pointer.Kind.Ref,
                                                            M.deref (| M.read (| bytecode |) |)
                                                          |)
                                                        ]
                                                      |)
                                                    ]
                                                  |) in
                                                let~ leading_pushdata : Ty.path "u8" :=
                                                  M.cast
                                                    (Ty.path "u8")
                                                    (M.call_closure (|
                                                      Ty.path "usize",
                                                      M.get_function (|
                                                        "core::cmp::min",
                                                        [],
                                                        [ Ty.path "usize" ]
                                                      |),
                                                      [
                                                        M.read (| pushdata_remaining |);
                                                        M.call_closure (|
                                                          Ty.path "usize",
                                                          BinOp.Wrap.sub,
                                                          [ M.read (| end_ |); M.read (| start |) ]
                                                        |)
                                                      ]
                                                    |)) in
                                                let~ data :
                                                    Ty.apply
                                                      (Ty.path "array")
                                                      [ Value.Integer IntegerKind.Usize 31 ]
                                                      [ Ty.path "u8" ] :=
                                                  lib.repeat (|
                                                    Value.Integer IntegerKind.U8 0,
                                                    Value.Integer IntegerKind.Usize 31
                                                  |) in
                                                let~ chunk_data :
                                                    Ty.apply
                                                      (Ty.path "&")
                                                      []
                                                      [
                                                        Ty.apply
                                                          (Ty.path "slice")
                                                          []
                                                          [ Ty.path "u8" ]
                                                      ] :=
                                                  M.borrow (|
                                                    Pointer.Kind.Ref,
                                                    M.deref (|
                                                      M.call_closure (|
                                                        Ty.apply
                                                          (Ty.path "&")
                                                          []
                                                          [
                                                            Ty.apply
                                                              (Ty.path "slice")
                                                              []
                                                              [ Ty.path "u8" ]
                                                          ],
                                                        M.get_trait_method (|
                                                          "core::ops::index::Index",
                                                          Ty.apply
                                                            (Ty.path "slice")
                                                            []
                                                            [ Ty.path "u8" ],
                                                          [],
                                                          [
                                                            Ty.apply
                                                              (Ty.path "core::ops::range::Range")
                                                              []
                                                              [ Ty.path "usize" ]
                                                          ],
                                                          "index",
                                                          [],
                                                          []
                                                        |),
                                                        [
                                                          M.borrow (|
                                                            Pointer.Kind.Ref,
                                                            M.deref (| M.read (| bytecode |) |)
                                                          |);
                                                          Value.mkStructRecord
                                                            "core::ops::range::Range"
                                                            []
                                                            [ Ty.path "usize" ]
                                                            [
                                                              ("start", M.read (| start |));
                                                              ("end_", M.read (| end_ |))
                                                            ]
                                                        ]
                                                      |)
                                                    |)
                                                  |) in
                                                let~ _ : Ty.tuple [] :=
                                                  M.call_closure (|
                                                    Ty.tuple [],
                                                    M.get_associated_function (|
                                                      Ty.apply
                                                        (Ty.path "slice")
                                                        []
                                                        [ Ty.path "u8" ],
                                                      "copy_from_slice",
                                                      [],
                                                      []
                                                    |),
                                                    [
                                                      M.borrow (|
                                                        Pointer.Kind.MutRef,
                                                        M.deref (|
                                                          M.call_closure (|
                                                            Ty.apply
                                                              (Ty.path "&mut")
                                                              []
                                                              [
                                                                Ty.apply
                                                                  (Ty.path "slice")
                                                                  []
                                                                  [ Ty.path "u8" ]
                                                              ],
                                                            M.get_trait_method (|
                                                              "core::ops::index::IndexMut",
                                                              Ty.apply
                                                                (Ty.path "array")
                                                                [ Value.Integer IntegerKind.Usize 31
                                                                ]
                                                                [ Ty.path "u8" ],
                                                              [],
                                                              [
                                                                Ty.apply
                                                                  (Ty.path
                                                                    "core::ops::range::RangeTo")
                                                                  []
                                                                  [ Ty.path "usize" ]
                                                              ],
                                                              "index_mut",
                                                              [],
                                                              []
                                                            |),
                                                            [
                                                              M.borrow (|
                                                                Pointer.Kind.MutRef,
                                                                data
                                                              |);
                                                              Value.mkStructRecord
                                                                "core::ops::range::RangeTo"
                                                                []
                                                                [ Ty.path "usize" ]
                                                                [
                                                                  ("end_",
                                                                    M.call_closure (|
                                                                      Ty.path "usize",
                                                                      M.get_associated_function (|
                                                                        Ty.apply
                                                                          (Ty.path "slice")
                                                                          []
                                                                          [ Ty.path "u8" ],
                                                                        "len",
                                                                        [],
                                                                        []
                                                                      |),
                                                                      [
                                                                        M.borrow (|
                                                                          Pointer.Kind.Ref,
                                                                          M.deref (|
                                                                            M.read (| chunk_data |)
                                                                          |)
                                                                        |)
                                                                      ]
                                                                    |))
                                                                ]
                                                            ]
                                                          |)
                                                        |)
                                                      |);
                                                      M.borrow (|
                                                        Pointer.Kind.Ref,
                                                        M.deref (| M.read (| chunk_data |) |)
                                                      |)
                                                    ]
                                                  |) in
                                                let~ _ : Ty.tuple [] :=
                                                  M.call_closure (|
                                                    Ty.tuple [],
                                                    M.get_associated_function (|
                                                      Ty.apply
                                                        (Ty.path "alloc::vec::Vec")
                                                        []
                                                        [
                                                          Ty.path "ubt::code::CodeChunk";
                                                          Ty.path "alloc::alloc::Global"
                                                        ],
                                                      "push",
                                                      [],
                                                      []
                                                    |),
                                                    [
                                                      M.borrow (| Pointer.Kind.MutRef, chunks |);
                                                      M.call_closure (|
                                                        Ty.path "ubt::code::CodeChunk",
                                                        M.get_associated_function (|
                                                          Ty.path "ubt::code::CodeChunk",
                                                          "new",
                                                          [],
                                                          []
                                                        |),
                                                        [
                                                          M.read (| leading_pushdata |);
                                                          M.read (| data |)
                                                        ]
                                                      |)
                                                    ]
                                                  |) in
                                                M.alloc (|
                                                  Ty.tuple [],
                                                  M.match_operator (|
                                                    Ty.tuple [],
                                                    M.alloc (| Ty.tuple [], Value.Tuple [] |),
                                                    [
                                                      fun γ =>
                                                        ltac:(M.monadic
                                                          (let γ :=
                                                            M.use
                                                              (M.alloc (|
                                                                Ty.path "bool",
                                                                M.call_closure (|
                                                                  Ty.path "bool",
                                                                  BinOp.gt,
                                                                  [
                                                                    M.read (| pushdata_remaining |);
                                                                    M.read (|
                                                                      get_constant (|
                                                                        "ubt::code::CODE_CHUNK_DATA_SIZE",
                                                                        Ty.path "usize"
                                                                      |)
                                                                    |)
                                                                  ]
                                                                |)
                                                              |)) in
                                                          let _ :=
                                                            is_constant_or_break_match (|
                                                              M.read (| γ |),
                                                              Value.Bool true
                                                            |) in
                                                          M.read (|
                                                            let~ _ : Ty.tuple [] :=
                                                              let β := pushdata_remaining in
                                                              M.write (|
                                                                β,
                                                                M.call_closure (|
                                                                  Ty.path "usize",
                                                                  BinOp.Wrap.sub,
                                                                  [
                                                                    M.read (| β |);
                                                                    M.read (|
                                                                      get_constant (|
                                                                        "ubt::code::CODE_CHUNK_DATA_SIZE",
                                                                        Ty.path "usize"
                                                                      |)
                                                                    |)
                                                                  ]
                                                                |)
                                                              |) in
                                                            M.alloc (|
                                                              Ty.tuple [],
                                                              Value.Tuple []
                                                            |)
                                                          |)));
                                                      fun γ =>
                                                        ltac:(M.monadic
                                                          (M.read (|
                                                            let~ _ : Ty.tuple [] :=
                                                              M.write (|
                                                                pushdata_remaining,
                                                                Value.Integer IntegerKind.Usize 0
                                                              |) in
                                                            let~ i : Ty.path "usize" :=
                                                              M.call_closure (|
                                                                Ty.path "usize",
                                                                M.get_trait_method (|
                                                                  "core::cmp::Ord",
                                                                  Ty.path "usize",
                                                                  [],
                                                                  [],
                                                                  "max",
                                                                  [],
                                                                  []
                                                                |),
                                                                [
                                                                  M.read (| pushdata_remaining |);
                                                                  M.cast
                                                                    (Ty.path "usize")
                                                                    (M.read (| leading_pushdata |))
                                                                ]
                                                              |) in
                                                            M.loop (|
                                                              Ty.tuple [],
                                                              ltac:(M.monadic
                                                                (M.alloc (|
                                                                  Ty.tuple [],
                                                                  M.match_operator (|
                                                                    Ty.tuple [],
                                                                    M.alloc (|
                                                                      Ty.tuple [],
                                                                      Value.Tuple []
                                                                    |),
                                                                    [
                                                                      fun γ =>
                                                                        ltac:(M.monadic
                                                                          (let γ :=
                                                                            M.use
                                                                              (M.alloc (|
                                                                                Ty.path "bool",
                                                                                M.call_closure (|
                                                                                  Ty.path "bool",
                                                                                  BinOp.lt,
                                                                                  [
                                                                                    M.read (| i |);
                                                                                    M.call_closure (|
                                                                                      Ty.path
                                                                                        "usize",
                                                                                      M.get_associated_function (|
                                                                                        Ty.apply
                                                                                          (Ty.path
                                                                                            "slice")
                                                                                          []
                                                                                          [
                                                                                            Ty.path
                                                                                              "u8"
                                                                                          ],
                                                                                        "len",
                                                                                        [],
                                                                                        []
                                                                                      |),
                                                                                      [
                                                                                        M.borrow (|
                                                                                          Pointer.Kind.Ref,
                                                                                          M.deref (|
                                                                                            M.read (|
                                                                                              chunk_data
                                                                                            |)
                                                                                          |)
                                                                                        |)
                                                                                      ]
                                                                                    |)
                                                                                  ]
                                                                                |)
                                                                              |)) in
                                                                          let _ :=
                                                                            is_constant_or_break_match (|
                                                                              M.read (| γ |),
                                                                              Value.Bool true
                                                                            |) in
                                                                          M.read (|
                                                                            let~ opcode :
                                                                                Ty.path "u8" :=
                                                                              M.read (|
                                                                                M.SubPointer.get_array_field (|
                                                                                  M.deref (|
                                                                                    M.read (|
                                                                                      chunk_data
                                                                                    |)
                                                                                  |),
                                                                                  M.read (| i |)
                                                                                |)
                                                                              |) in
                                                                            let~ push_bytes :
                                                                                Ty.path "usize" :=
                                                                              M.call_closure (|
                                                                                Ty.path "usize",
                                                                                M.get_function (|
                                                                                  "ubt::code::push_size",
                                                                                  [],
                                                                                  []
                                                                                |),
                                                                                [
                                                                                  M.read (|
                                                                                    opcode
                                                                                  |)
                                                                                ]
                                                                              |) in
                                                                            M.alloc (|
                                                                              Ty.tuple [],
                                                                              M.match_operator (|
                                                                                Ty.tuple [],
                                                                                M.alloc (|
                                                                                  Ty.tuple [],
                                                                                  Value.Tuple []
                                                                                |),
                                                                                [
                                                                                  fun γ =>
                                                                                    ltac:(M.monadic
                                                                                      (let γ :=
                                                                                        M.use
                                                                                          (M.alloc (|
                                                                                            Ty.path
                                                                                              "bool",
                                                                                            M.call_closure (|
                                                                                              Ty.path
                                                                                                "bool",
                                                                                              BinOp.gt,
                                                                                              [
                                                                                                M.read (|
                                                                                                  push_bytes
                                                                                                |);
                                                                                                Value.Integer
                                                                                                  IntegerKind.Usize
                                                                                                  0
                                                                                              ]
                                                                                            |)
                                                                                          |)) in
                                                                                      let _ :=
                                                                                        is_constant_or_break_match (|
                                                                                          M.read (|
                                                                                            γ
                                                                                          |),
                                                                                          Value.Bool
                                                                                            true
                                                                                        |) in
                                                                                      M.read (|
                                                                                        let~
                                                                                              bytes_in_chunk :
                                                                                            Ty.path
                                                                                              "usize" :=
                                                                                          M.call_closure (|
                                                                                            Ty.path
                                                                                              "usize",
                                                                                            BinOp.Wrap.sub,
                                                                                            [
                                                                                              M.call_closure (|
                                                                                                Ty.path
                                                                                                  "usize",
                                                                                                BinOp.Wrap.sub,
                                                                                                [
                                                                                                  M.call_closure (|
                                                                                                    Ty.path
                                                                                                      "usize",
                                                                                                    M.get_associated_function (|
                                                                                                      Ty.apply
                                                                                                        (Ty.path
                                                                                                          "slice")
                                                                                                        []
                                                                                                        [
                                                                                                          Ty.path
                                                                                                            "u8"
                                                                                                        ],
                                                                                                      "len",
                                                                                                      [],
                                                                                                      []
                                                                                                    |),
                                                                                                    [
                                                                                                      M.borrow (|
                                                                                                        Pointer.Kind.Ref,
                                                                                                        M.deref (|
                                                                                                          M.read (|
                                                                                                            chunk_data
                                                                                                          |)
                                                                                                        |)
                                                                                                      |)
                                                                                                    ]
                                                                                                  |);
                                                                                                  M.read (|
                                                                                                    i
                                                                                                  |)
                                                                                                ]
                                                                                              |);
                                                                                              Value.Integer
                                                                                                IntegerKind.Usize
                                                                                                1
                                                                                            ]
                                                                                          |) in
                                                                                        let~ _ :
                                                                                            Ty.tuple
                                                                                              [] :=
                                                                                          M.match_operator (|
                                                                                            Ty.tuple
                                                                                              [],
                                                                                            M.alloc (|
                                                                                              Ty.tuple
                                                                                                [],
                                                                                              Value.Tuple
                                                                                                []
                                                                                            |),
                                                                                            [
                                                                                              fun
                                                                                                  γ =>
                                                                                                ltac:(M.monadic
                                                                                                  (let
                                                                                                        γ :=
                                                                                                    M.use
                                                                                                      (M.alloc (|
                                                                                                        Ty.path
                                                                                                          "bool",
                                                                                                        M.call_closure (|
                                                                                                          Ty.path
                                                                                                            "bool",
                                                                                                          BinOp.gt,
                                                                                                          [
                                                                                                            M.read (|
                                                                                                              push_bytes
                                                                                                            |);
                                                                                                            M.read (|
                                                                                                              bytes_in_chunk
                                                                                                            |)
                                                                                                          ]
                                                                                                        |)
                                                                                                      |)) in
                                                                                                  let
                                                                                                        _ :=
                                                                                                    is_constant_or_break_match (|
                                                                                                      M.read (|
                                                                                                        γ
                                                                                                      |),
                                                                                                      Value.Bool
                                                                                                        true
                                                                                                    |) in
                                                                                                  M.read (|
                                                                                                    let~
                                                                                                          _ :
                                                                                                        Ty.tuple
                                                                                                          [] :=
                                                                                                      M.write (|
                                                                                                        pushdata_remaining,
                                                                                                        M.call_closure (|
                                                                                                          Ty.path
                                                                                                            "usize",
                                                                                                          BinOp.Wrap.sub,
                                                                                                          [
                                                                                                            M.read (|
                                                                                                              push_bytes
                                                                                                            |);
                                                                                                            M.read (|
                                                                                                              bytes_in_chunk
                                                                                                            |)
                                                                                                          ]
                                                                                                        |)
                                                                                                      |) in
                                                                                                    M.alloc (|
                                                                                                      Ty.tuple
                                                                                                        [],
                                                                                                      Value.Tuple
                                                                                                        []
                                                                                                    |)
                                                                                                  |)));
                                                                                              fun
                                                                                                  γ =>
                                                                                                ltac:(M.monadic
                                                                                                  (Value.Tuple
                                                                                                    []))
                                                                                            ]
                                                                                          |) in
                                                                                        let~ _ :
                                                                                            Ty.tuple
                                                                                              [] :=
                                                                                          let β :=
                                                                                            i in
                                                                                          M.write (|
                                                                                            β,
                                                                                            M.call_closure (|
                                                                                              Ty.path
                                                                                                "usize",
                                                                                              BinOp.Wrap.add,
                                                                                              [
                                                                                                M.read (|
                                                                                                  β
                                                                                                |);
                                                                                                M.call_closure (|
                                                                                                  Ty.path
                                                                                                    "usize",
                                                                                                  BinOp.Wrap.add,
                                                                                                  [
                                                                                                    M.read (|
                                                                                                      push_bytes
                                                                                                    |);
                                                                                                    Value.Integer
                                                                                                      IntegerKind.Usize
                                                                                                      1
                                                                                                  ]
                                                                                                |)
                                                                                              ]
                                                                                            |)
                                                                                          |) in
                                                                                        M.alloc (|
                                                                                          Ty.tuple
                                                                                            [],
                                                                                          Value.Tuple
                                                                                            []
                                                                                        |)
                                                                                      |)));
                                                                                  fun γ =>
                                                                                    ltac:(M.monadic
                                                                                      (M.read (|
                                                                                        let~ _ :
                                                                                            Ty.tuple
                                                                                              [] :=
                                                                                          let β :=
                                                                                            i in
                                                                                          M.write (|
                                                                                            β,
                                                                                            M.call_closure (|
                                                                                              Ty.path
                                                                                                "usize",
                                                                                              BinOp.Wrap.add,
                                                                                              [
                                                                                                M.read (|
                                                                                                  β
                                                                                                |);
                                                                                                Value.Integer
                                                                                                  IntegerKind.Usize
                                                                                                  1
                                                                                              ]
                                                                                            |)
                                                                                          |) in
                                                                                        M.alloc (|
                                                                                          Ty.tuple
                                                                                            [],
                                                                                          Value.Tuple
                                                                                            []
                                                                                        |)
                                                                                      |)))
                                                                                ]
                                                                              |)
                                                                            |)
                                                                          |)));
                                                                      fun γ =>
                                                                        ltac:(M.monadic
                                                                          (M.never_to_any (|
                                                                            M.read (|
                                                                              let~ _ :
                                                                                  Ty.tuple [] :=
                                                                                M.never_to_any (|
                                                                                  M.read (|
                                                                                    M.break (||)
                                                                                  |)
                                                                                |) in
                                                                              M.alloc (|
                                                                                Ty.tuple [],
                                                                                Value.Tuple []
                                                                              |)
                                                                            |)
                                                                          |)))
                                                                    ]
                                                                  |)
                                                                |)))
                                                            |)
                                                          |)))
                                                    ]
                                                  |)
                                                |)
                                              |)))
                                        ]
                                      |) in
                                    M.alloc (| Ty.tuple [], Value.Tuple [] |)))
                                |)
                              |)))
                        ]
                      |)
                    |))
                |) in
              chunks
            |)))
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_chunkify_code :
    M.IsFunction.C "ubt::code::chunkify_code" chunkify_code.
  Admitted.
  Global Typeclasses Opaque chunkify_code.
  
  (*
  pub fn dechunkify_code(chunks: &[CodeChunk], code_size: usize) -> Vec<u8> {
      let mut bytecode = Vec::with_capacity(code_size);
      
      for chunk in chunks {
          let remaining = code_size.saturating_sub(bytecode.len());
          let to_copy = std::cmp::min(remaining, CODE_CHUNK_DATA_SIZE);
          bytecode.extend_from_slice(&chunk.data[..to_copy]);
      }
      
      bytecode
  }
  *)
  Definition dechunkify_code (ε : list Value.t) (τ : list Ty.t) (α : list Value.t) : M :=
    match ε, τ, α with
    | [], [], [ chunks; code_size ] =>
      ltac:(M.monadic
        (let chunks :=
          M.alloc (|
            Ty.apply
              (Ty.path "&")
              []
              [ Ty.apply (Ty.path "slice") [] [ Ty.path "ubt::code::CodeChunk" ] ],
            chunks
          |) in
        let code_size := M.alloc (| Ty.path "usize", code_size |) in
        M.read (|
          let~ bytecode :
              Ty.apply
                (Ty.path "alloc::vec::Vec")
                []
                [ Ty.path "u8"; Ty.path "alloc::alloc::Global" ] :=
            M.call_closure (|
              Ty.apply
                (Ty.path "alloc::vec::Vec")
                []
                [ Ty.path "u8"; Ty.path "alloc::alloc::Global" ],
              M.get_associated_function (|
                Ty.apply
                  (Ty.path "alloc::vec::Vec")
                  []
                  [ Ty.path "u8"; Ty.path "alloc::alloc::Global" ],
                "with_capacity",
                [],
                []
              |),
              [ M.read (| code_size |) ]
            |) in
          let~ _ : Ty.tuple [] :=
            M.read (|
              M.use
                (M.alloc (|
                  Ty.tuple [],
                  M.match_operator (|
                    Ty.tuple [],
                    M.alloc (|
                      Ty.apply
                        (Ty.path "core::slice::iter::Iter")
                        []
                        [ Ty.path "ubt::code::CodeChunk" ],
                      M.call_closure (|
                        Ty.apply
                          (Ty.path "core::slice::iter::Iter")
                          []
                          [ Ty.path "ubt::code::CodeChunk" ],
                        M.get_trait_method (|
                          "core::iter::traits::collect::IntoIterator",
                          Ty.apply
                            (Ty.path "&")
                            []
                            [ Ty.apply (Ty.path "slice") [] [ Ty.path "ubt::code::CodeChunk" ] ],
                          [],
                          [],
                          "into_iter",
                          [],
                          []
                        |),
                        [ M.read (| chunks |) ]
                      |)
                    |),
                    [
                      fun γ =>
                        ltac:(M.monadic
                          (let iter :=
                            M.copy (|
                              Ty.apply
                                (Ty.path "core::slice::iter::Iter")
                                []
                                [ Ty.path "ubt::code::CodeChunk" ],
                              γ
                            |) in
                          M.read (|
                            M.loop (|
                              Ty.tuple [],
                              ltac:(M.monadic
                                (let~ _ : Ty.tuple [] :=
                                  M.match_operator (|
                                    Ty.tuple [],
                                    M.alloc (|
                                      Ty.apply
                                        (Ty.path "core::option::Option")
                                        []
                                        [
                                          Ty.apply
                                            (Ty.path "&")
                                            []
                                            [ Ty.path "ubt::code::CodeChunk" ]
                                        ],
                                      M.call_closure (|
                                        Ty.apply
                                          (Ty.path "core::option::Option")
                                          []
                                          [
                                            Ty.apply
                                              (Ty.path "&")
                                              []
                                              [ Ty.path "ubt::code::CodeChunk" ]
                                          ],
                                        M.get_trait_method (|
                                          "core::iter::traits::iterator::Iterator",
                                          Ty.apply
                                            (Ty.path "core::slice::iter::Iter")
                                            []
                                            [ Ty.path "ubt::code::CodeChunk" ],
                                          [],
                                          [],
                                          "next",
                                          [],
                                          []
                                        |),
                                        [
                                          M.borrow (|
                                            Pointer.Kind.MutRef,
                                            M.deref (| M.borrow (| Pointer.Kind.MutRef, iter |) |)
                                          |)
                                        ]
                                      |)
                                    |),
                                    [
                                      fun γ =>
                                        ltac:(M.monadic
                                          (let _ :=
                                            M.is_struct_tuple (|
                                              γ,
                                              "core::option::Option::None"
                                            |) in
                                          M.never_to_any (| M.read (| M.break (||) |) |)));
                                      fun γ =>
                                        ltac:(M.monadic
                                          (let γ0_0 :=
                                            M.SubPointer.get_struct_tuple_field (|
                                              γ,
                                              "core::option::Option::Some",
                                              0
                                            |) in
                                          let chunk :=
                                            M.copy (|
                                              Ty.apply
                                                (Ty.path "&")
                                                []
                                                [ Ty.path "ubt::code::CodeChunk" ],
                                              γ0_0
                                            |) in
                                          M.read (|
                                            let~ remaining : Ty.path "usize" :=
                                              M.call_closure (|
                                                Ty.path "usize",
                                                M.get_associated_function (|
                                                  Ty.path "usize",
                                                  "saturating_sub",
                                                  [],
                                                  []
                                                |),
                                                [
                                                  M.read (| code_size |);
                                                  M.call_closure (|
                                                    Ty.path "usize",
                                                    M.get_associated_function (|
                                                      Ty.apply
                                                        (Ty.path "alloc::vec::Vec")
                                                        []
                                                        [
                                                          Ty.path "u8";
                                                          Ty.path "alloc::alloc::Global"
                                                        ],
                                                      "len",
                                                      [],
                                                      []
                                                    |),
                                                    [ M.borrow (| Pointer.Kind.Ref, bytecode |) ]
                                                  |)
                                                ]
                                              |) in
                                            let~ to_copy : Ty.path "usize" :=
                                              M.call_closure (|
                                                Ty.path "usize",
                                                M.get_function (|
                                                  "core::cmp::min",
                                                  [],
                                                  [ Ty.path "usize" ]
                                                |),
                                                [
                                                  M.read (| remaining |);
                                                  M.read (|
                                                    get_constant (|
                                                      "ubt::code::CODE_CHUNK_DATA_SIZE",
                                                      Ty.path "usize"
                                                    |)
                                                  |)
                                                ]
                                              |) in
                                            let~ _ : Ty.tuple [] :=
                                              M.call_closure (|
                                                Ty.tuple [],
                                                M.get_associated_function (|
                                                  Ty.apply
                                                    (Ty.path "alloc::vec::Vec")
                                                    []
                                                    [ Ty.path "u8"; Ty.path "alloc::alloc::Global"
                                                    ],
                                                  "extend_from_slice",
                                                  [],
                                                  []
                                                |),
                                                [
                                                  M.borrow (| Pointer.Kind.MutRef, bytecode |);
                                                  M.borrow (|
                                                    Pointer.Kind.Ref,
                                                    M.deref (|
                                                      M.borrow (|
                                                        Pointer.Kind.Ref,
                                                        M.deref (|
                                                          M.call_closure (|
                                                            Ty.apply
                                                              (Ty.path "&")
                                                              []
                                                              [
                                                                Ty.apply
                                                                  (Ty.path "slice")
                                                                  []
                                                                  [ Ty.path "u8" ]
                                                              ],
                                                            M.get_trait_method (|
                                                              "core::ops::index::Index",
                                                              Ty.apply
                                                                (Ty.path "array")
                                                                [ Value.Integer IntegerKind.Usize 31
                                                                ]
                                                                [ Ty.path "u8" ],
                                                              [],
                                                              [
                                                                Ty.apply
                                                                  (Ty.path
                                                                    "core::ops::range::RangeTo")
                                                                  []
                                                                  [ Ty.path "usize" ]
                                                              ],
                                                              "index",
                                                              [],
                                                              []
                                                            |),
                                                            [
                                                              M.borrow (|
                                                                Pointer.Kind.Ref,
                                                                M.SubPointer.get_struct_record_field (|
                                                                  M.deref (| M.read (| chunk |) |),
                                                                  "ubt::code::CodeChunk",
                                                                  "data"
                                                                |)
                                                              |);
                                                              Value.mkStructRecord
                                                                "core::ops::range::RangeTo"
                                                                []
                                                                [ Ty.path "usize" ]
                                                                [ ("end_", M.read (| to_copy |)) ]
                                                            ]
                                                          |)
                                                        |)
                                                      |)
                                                    |)
                                                  |)
                                                ]
                                              |) in
                                            M.alloc (| Ty.tuple [], Value.Tuple [] |)
                                          |)))
                                    ]
                                  |) in
                                M.alloc (| Ty.tuple [], Value.Tuple [] |)))
                            |)
                          |)))
                    ]
                  |)
                |))
            |) in
          bytecode
        |)))
    | _, _, _ => M.impossible "wrong number of arguments"
    end.
  
  Global Instance Instance_IsFunction_dechunkify_code :
    M.IsFunction.C "ubt::code::dechunkify_code" dechunkify_code.
  Admitted.
  Global Typeclasses Opaque dechunkify_code.
End code.
